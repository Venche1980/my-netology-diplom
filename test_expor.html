<!DOCTYPE html>
<html>
<head>
    <title>Тест экспорта товаров</title>
</head>
<body>
    <h1>Тест экспорта товаров</h1>

    <div>
        <label>Email магазина:</label>
        <input type="email" id="email" value="shop@example.com"><br><br>

        <label>Пароль:</label>
        <input type="password" id="password" value="shoppassword"><br><br>

        <button onclick="login()">1. Войти</button>
        <div id="token-info"></div>
    </div>

    <br><hr><br>

    <div>
        <button onclick="exportProducts()" disabled id="export-btn">2. Экспортировать товары</button>
        <div id="result"></div>
    </div>

    <script>
        let authToken = '';

        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            const response = await fetch('http://127.0.0.1:8000/api/v1/user/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({email, password})
            });

            const data = await response.json();

            if (data.Status) {
                authToken = data.Token;
                document.getElementById('token-info').innerHTML =
                    '<p style="color: green">Успешно! Токен получен: ' + authToken.substring(0, 10) + '...</p>';
                document.getElementById('export-btn').disabled = false;
            } else {
                document.getElementById('token-info').innerHTML =
                    '<p style="color: red">Ошибка: ' + JSON.stringify(data) + '</p>';
            }
        }

        async function exportProducts() {
            const response = await fetch('http://127.0.0.1:8000/api/v1/partner/export', {
                method: 'GET',
                headers: {
                    'Authorization': 'Token ' + authToken
                }
            });

            if (response.ok) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'products.yaml';
                a.click();

                document.getElementById('result').innerHTML =
                    '<p style="color: green">Файл успешно загружен!</p>';
            } else {
                const error = await response.text();
                document.getElementById('result').innerHTML =
                    '<p style="color: red">Ошибка: ' + error + '</p>';
            }
        }
    </script>
</body>
</html>